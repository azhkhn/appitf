#! /usr/bin/env python3
"""appitfd.

    Application interface daemon for system interaction.

    This interface provides a HTTP service to allow an
    Adobe AIR or HTML5 digital signage application to
    interact with the local operating system.

Usage:
    appitfd [options]

Options:
    --host=<host>, -H   Specifies the host to listen on [default: 127.0.0.1].
    --port=<port>, -p   Specifies the port to listen on [default: 5000].
    --help, -h          Shows this page.
"""
from sys import stderr, exit as exit_

from docopt import docopt
from flask import Flask

from backlight import NoSupportedGraphicsCards, Backlight


HOST = '127.0.0.1'
PORT = 5000
APPLICATION = Flask('AppItf')


@APPLICATION.route('/backlight/<int:brightness>', methods=['POST'])
def set_backlight(brightness):
    """Sets the backlight brightness."""

    try:
        backlight = Backlight.load()
    except NoSupportedGraphicsCards:
        return ('No supported graphics card found.', 503)

    try:
        backlight.percent = brightness
    except ValueError as value_error:
        return (str(value_error), 400)
    except PermissionError:
        return ('Service is not running as root.', 500)

    return f'Brightness set to {brightness}%.'


def main(options):
    """Runs the daemon."""

    host = options['--host']
    port = options['--port']

    try:
        port = int(port)
    except ValueError:
        print(f'Port number must be an integer, not "{port}".', file=stderr)
        return 1

    APPLICATION.run(host=host, port=port)
    return 0


if __name__ == '__main__':
    exit_(main(docopt(__doc__)))
